name: Build Binaries

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  FORCE_COLOR: 0
  NO_COLOR: 1

jobs:
  build-linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync --extra dev

    - name: Build Linux binary
      run: ./scripts/build-binary.sh --platform linux

    - name: Test binary
      run: |
        echo "Testing Linux binary..."
        ./dist/vtt2minutes --help
        echo "Binary test completed successfully"

    - name: Upload Linux binary
      uses: actions/upload-artifact@v4
      with:
        name: vtt2minutes-linux-x86_64
        path: dist/vtt2minutes
        retention-days: 30

  build-windows:
    name: Build Windows Binary
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync --extra dev

    - name: Build Windows binary
      run: |
        # Use PowerShell to run the build script
        bash ./scripts/build-binary.sh --platform windows

    - name: Test binary
      run: |
        echo "Testing Windows binary..."
        ./dist/vtt2minutes.exe --help
        echo "Binary test completed successfully"

    - name: Upload Windows binary
      uses: actions/upload-artifact@v4
      with:
        name: vtt2minutes-windows-x86_64
        path: dist/vtt2minutes.exe
        retention-days: 30

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Linux binary
      uses: actions/download-artifact@v4
      with:
        name: vtt2minutes-linux-x86_64
        path: ./binaries/linux/

    - name: Download Windows binary
      uses: actions/download-artifact@v4
      with:
        name: vtt2minutes-windows-x86_64
        path: ./binaries/windows/

    - name: Prepare release assets
      run: |
        # Create release directory structure
        mkdir -p release
        
        # Package Linux binary
        cd binaries/linux
        tar -czf ../../release/vtt2minutes-linux-x86_64.tar.gz vtt2minutes
        cd ../..
        
        # Package Windows binary
        cd binaries/windows
        zip ../../release/vtt2minutes-windows-x86_64.zip vtt2minutes.exe
        cd ../..
        
        # List release assets
        echo "Release assets:"
        ls -la release/

    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create release notes
      id: release_notes
      run: |
        # Generate Japanese release notes
        echo "## VTT2Minutes ${{ steps.version.outputs.tag }}" > release_notes.md
        echo "" >> release_notes.md
        echo "Microsoft Teams ã® VTT å½¢å¼è­°äº‹éŒ²ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã€Amazon Bedrock ã‚’æ´»ç”¨ã—ã¦ AI ã«ã‚ˆã‚‹è­°äº‹éŒ²ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹æ—¥æœ¬èªžå°‚ç”¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ä¸»ãªç‰¹å¾´" >> release_notes.md
        echo "" >> release_notes.md
        echo "- **æ—¥æœ¬èªžç‰¹åŒ–**: æ—¥æœ¬èªžã®ãƒ•ã‚£ãƒ©ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨å¥èª­ç‚¹å‡¦ç†ã«æœ€é©åŒ–" >> release_notes.md
        echo "- **AI è­°äº‹éŒ²ç”Ÿæˆ**: Claude Sonnet 4 å¯¾å¿œã®é«˜å“è³ªãªè­°äº‹éŒ²ç”Ÿæˆ" >> release_notes.md
        echo "- **æŽ¨è«–ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ**: Bedrock Cross-Region Inference ã§ã‚³ã‚¹ãƒˆæœ€é©åŒ–" >> release_notes.md
        echo "- **ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: è©³ç´°ãªè­°äº‹éŒ²ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæä¾›" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> release_notes.md
        echo "" >> release_notes.md
        echo "- **Linux (x86_64)**: \`vtt2minutes-linux-x86_64.tar.gz\`" >> release_notes.md
        echo "- **Windows (x86_64)**: \`vtt2minutes-windows-x86_64.zip\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ä½¿ç”¨æ–¹æ³•" >> release_notes.md
        echo "" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "# Linux" >> release_notes.md
        echo "tar -xzf vtt2minutes-linux-x86_64.tar.gz" >> release_notes.md
        echo "./vtt2minutes meeting.vtt -t \"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¼ç”»ä¼šè­°\"" >> release_notes.md
        echo "" >> release_notes.md
        echo "# Windows (PowerShell)" >> release_notes.md
        echo "Expand-Archive vtt2minutes-windows-x86_64.zip" >> release_notes.md
        echo "vtt2minutes.exe meeting.vtt -t \"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¼ç”»ä¼šè­°\"" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### æŽ¨å¥¨ãƒ¢ãƒ‡ãƒ«è¨­å®š" >> release_notes.md
        echo "" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "# Claude Sonnet 4ï¼ˆæœ€é«˜å“è³ªï¼‰" >> release_notes.md
        echo "vtt2minutes meeting.vtt --bedrock-model anthropic.claude-sonnet-4-20250514" >> release_notes.md
        echo "" >> release_notes.md
        echo "# æŽ¨è«–ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼‰" >> release_notes.md
        echo "vtt2minutes meeting.vtt --bedrock-inference-profile-id apac-claude-sonnet-4" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### å¿…è¦ãªç’°å¢ƒ" >> release_notes.md
        echo "" >> release_notes.md
        echo "- Amazon Bedrock ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æŒã¤ AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ" >> release_notes.md
        echo "- è¨­å®šæ¸ˆã¿ AWS èªè¨¼æƒ…å ±ï¼ˆç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ AWS CLI ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰" >> release_notes.md
        echo "- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶š" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ã‚µãƒãƒ¼ãƒˆ" >> release_notes.md
        echo "" >> release_notes.md
        echo "- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [README.md](https://github.com/kiririmode/vtt2minutes/blob/main/README.md)" >> release_notes.md
        echo "- **ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ**: [Issues](https://github.com/kiririmode/vtt2minutes/issues)" >> release_notes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: VTT2Minutes ${{ steps.version.outputs.tag }}
        body_path: release_notes.md
        files: |
          release/vtt2minutes-linux-x86_64.tar.gz
          release/vtt2minutes-windows-x86_64.zip
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, 'rc') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    if: always()
    
    steps:
    - name: Build status summary
      run: |
        echo "## Binary Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Linux | ${{ needs.build-linux.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Windows | ${{ needs.build-windows.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.build-linux.result }}" == "success" && "${{ needs.build-windows.result }}" == "success" ]]; then
          echo "ðŸŽ‰ All binaries built successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Some builds failed. Check the individual job logs for details." >> $GITHUB_STEP_SUMMARY
        fi